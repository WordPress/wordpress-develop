{"version":3,"names":["_uuid","require","_i18n","_icons","_richText","_blockEditor","_data","_coreData","_blocks","_lockUnlock","usesContextKey","unlock","privateApis","formatName","exports","POST_CONTENT_BLOCK_NAME","SYNCED_PATTERN_BLOCK_NAME","format","title","__","tagName","className","attributes","interactive","contentEditable","edit","Edit","value","onChange","isObjectActive","context","postType","postId","registry","useRegistry","getSelectedBlockClientId","getBlocks","getBlockRootClientId","getBlockName","getBlockParentsByBlockName","select","blockEditorStore","isFootnotesSupported","useSelect","blocksStore","getBlockType","entityRecord","coreDataStore","getEntityRecord","meta","footnotes","_getBlockParentsByBlockName","_getSelectedBlockClientId","parentCoreBlocks","length","selectionChange","insertBlock","useDispatch","onClick","batch","id","object","replacements","start","createId","newValue","insertObject","type","innerHTML","end","selectedClientId","parentPostContent","blocks","fnBlock","queue","block","shift","name","push","innerBlocks","rootClientId","createBlock","undefined","clientId","_react","createElement","RichTextToolbarButton","icon","isActive"],"sources":["@wordpress/block-library/src/footnotes/format.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as createId } from 'uuid';\n\n/**\n * WordPress dependencies\n */\nimport { __ } from '@wordpress/i18n';\nimport { formatListNumbered as icon } from '@wordpress/icons';\nimport { insertObject } from '@wordpress/rich-text';\nimport {\n\tRichTextToolbarButton,\n\tstore as blockEditorStore,\n\tprivateApis,\n} from '@wordpress/block-editor';\nimport { useSelect, useDispatch, useRegistry } from '@wordpress/data';\nimport { store as coreDataStore } from '@wordpress/core-data';\nimport { createBlock, store as blocksStore } from '@wordpress/blocks';\n\n/**\n * Internal dependencies\n */\nimport { unlock } from '../lock-unlock';\n\nconst { usesContextKey } = unlock( privateApis );\n\nexport const formatName = 'core/footnote';\n\nconst POST_CONTENT_BLOCK_NAME = 'core/post-content';\nconst SYNCED_PATTERN_BLOCK_NAME = 'core/block';\n\nexport const format = {\n\ttitle: __( 'Footnote' ),\n\ttagName: 'sup',\n\tclassName: 'fn',\n\tattributes: {\n\t\t'data-fn': 'data-fn',\n\t},\n\tinteractive: true,\n\tcontentEditable: false,\n\t[ usesContextKey ]: [ 'postType', 'postId' ],\n\tedit: function Edit( {\n\t\tvalue,\n\t\tonChange,\n\t\tisObjectActive,\n\t\tcontext: { postType, postId },\n\t} ) {\n\t\tconst registry = useRegistry();\n\t\tconst {\n\t\t\tgetSelectedBlockClientId,\n\t\t\tgetBlocks,\n\t\t\tgetBlockRootClientId,\n\t\t\tgetBlockName,\n\t\t\tgetBlockParentsByBlockName,\n\t\t} = registry.select( blockEditorStore );\n\t\tconst isFootnotesSupported = useSelect(\n\t\t\t( select ) => {\n\t\t\t\tif (\n\t\t\t\t\t! select( blocksStore ).getBlockType( 'core/footnotes' )\n\t\t\t\t) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tconst entityRecord = select( coreDataStore ).getEntityRecord(\n\t\t\t\t\t'postType',\n\t\t\t\t\tpostType,\n\t\t\t\t\tpostId\n\t\t\t\t);\n\n\t\t\t\tif ( 'string' !== typeof entityRecord?.meta?.footnotes ) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t// Checks if the selected block lives within a pattern.\n\t\t\t\tconst {\n\t\t\t\t\tgetBlockParentsByBlockName: _getBlockParentsByBlockName,\n\t\t\t\t\tgetSelectedBlockClientId: _getSelectedBlockClientId,\n\t\t\t\t} = select( blockEditorStore );\n\t\t\t\tconst parentCoreBlocks = _getBlockParentsByBlockName(\n\t\t\t\t\t_getSelectedBlockClientId(),\n\t\t\t\t\tSYNCED_PATTERN_BLOCK_NAME\n\t\t\t\t);\n\t\t\t\treturn ! parentCoreBlocks || parentCoreBlocks.length === 0;\n\t\t\t},\n\t\t\t[ postType, postId ]\n\t\t);\n\n\t\tconst { selectionChange, insertBlock } =\n\t\t\tuseDispatch( blockEditorStore );\n\n\t\tif ( ! isFootnotesSupported ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tfunction onClick() {\n\t\t\tregistry.batch( () => {\n\t\t\t\tlet id;\n\t\t\t\tif ( isObjectActive ) {\n\t\t\t\t\tconst object = value.replacements[ value.start ];\n\t\t\t\t\tid = object?.attributes?.[ 'data-fn' ];\n\t\t\t\t} else {\n\t\t\t\t\tid = createId();\n\t\t\t\t\tconst newValue = insertObject(\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: formatName,\n\t\t\t\t\t\t\tattributes: {\n\t\t\t\t\t\t\t\t'data-fn': id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tinnerHTML: `<a href=\"#${ id }\" id=\"${ id }-link\">*</a>`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tvalue.end,\n\t\t\t\t\t\tvalue.end\n\t\t\t\t\t);\n\t\t\t\t\tnewValue.start = newValue.end - 1;\n\t\t\t\t\tonChange( newValue );\n\t\t\t\t}\n\n\t\t\t\tconst selectedClientId = getSelectedBlockClientId();\n\n\t\t\t\t/*\n\t\t\t\t * Attempts to find a common parent post content block.\n\t\t\t\t * This allows for locating blocks within a page edited in the site editor.\n\t\t\t\t */\n\t\t\t\tconst parentPostContent = getBlockParentsByBlockName(\n\t\t\t\t\tselectedClientId,\n\t\t\t\t\tPOST_CONTENT_BLOCK_NAME\n\t\t\t\t);\n\n\t\t\t\t// When called with a post content block, getBlocks will return\n\t\t\t\t// the block with controlled inner blocks included.\n\t\t\t\tconst blocks = parentPostContent.length\n\t\t\t\t\t? getBlocks( parentPostContent[ 0 ] )\n\t\t\t\t\t: getBlocks();\n\n\t\t\t\t// BFS search to find the first footnote block.\n\t\t\t\tlet fnBlock = null;\n\t\t\t\t{\n\t\t\t\t\tconst queue = [ ...blocks ];\n\t\t\t\t\twhile ( queue.length ) {\n\t\t\t\t\t\tconst block = queue.shift();\n\t\t\t\t\t\tif ( block.name === 'core/footnotes' ) {\n\t\t\t\t\t\t\tfnBlock = block;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tqueue.push( ...block.innerBlocks );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Maybe this should all also be moved to the entity provider.\n\t\t\t\t// When there is no footnotes block in the post, create one and\n\t\t\t\t// insert it at the bottom.\n\t\t\t\tif ( ! fnBlock ) {\n\t\t\t\t\tlet rootClientId = getBlockRootClientId( selectedClientId );\n\n\t\t\t\t\twhile (\n\t\t\t\t\t\trootClientId &&\n\t\t\t\t\t\tgetBlockName( rootClientId ) !== POST_CONTENT_BLOCK_NAME\n\t\t\t\t\t) {\n\t\t\t\t\t\trootClientId = getBlockRootClientId( rootClientId );\n\t\t\t\t\t}\n\n\t\t\t\t\tfnBlock = createBlock( 'core/footnotes' );\n\n\t\t\t\t\tinsertBlock( fnBlock, undefined, rootClientId );\n\t\t\t\t}\n\n\t\t\t\tselectionChange( fnBlock.clientId, id, 0, 0 );\n\t\t\t} );\n\t\t}\n\n\t\treturn (\n\t\t\t<RichTextToolbarButton\n\t\t\t\ticon={ icon }\n\t\t\t\ttitle={ __( 'Footnote' ) }\n\t\t\t\tonClick={ onClick }\n\t\t\t\tisActive={ isObjectActive }\n\t\t\t/>\n\t\t);\n\t},\n};\n"],"mappings":"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"}